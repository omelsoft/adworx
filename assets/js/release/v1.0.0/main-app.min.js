/* AdWorxApp - v1.0.0 -  2017-01-18 12:01:46 */
function apiModifyTable(a,b,c){return angular.forEach(a,function(d,e){d.id==b&&(a[e]=c)}),a}var app=angular.module("adWorxApp",["ngRoute","ngTable","angularUtils.directives.dirPagination"]);app.config(["$routeProvider",function(a){a.when("/partners",{templateUrl:"templates/Partners.html",controller:"PartnerController"}).when("/publishers",{templateUrl:"templates/Publishers.html",controller:"PublishersController"}).when("/reports",{templateUrl:"templates/Reports.html",controller:"ReportsController"}).when("/placements",{templateUrl:"templates/Placements.html",controller:"PlacementsController"}).when("/sites",{templateUrl:"templates/Sites.html",controller:"SitesController"}).when("/overview",{templateUrl:"templates/Overview.html",controller:"OverviewController"}).when("/pubPartners",{templateUrl:"/app/templates/PubPartner.html",controller:"PubPartnersController"}).when("/pubSites",{templateUrl:"/app/templates/PubSites.html",controller:"PubSitesController"}).when("/pubPlacements",{templateUrl:"/app/templates/PubPlacements.html",controller:"PubPlacementsController"}).when("/pubReports",{templateUrl:"/app/templates/PubReports.html",controller:"PubReportsController"}).otherwise({redirectTo:"/reports"})}]),app.factory("dataFactory",["$http",function(a){var b={httpRequest:function(b,c,d,e,f){var g={};g.url=b,"undefined"==typeof c?g.method="GET":g.method=c,"undefined"!=typeof d&&(g.params=d,g.params=d),"undefined"!=typeof e&&(g.data=e),"undefined"!=typeof f&&(g.upload=f);var h=a(g).then(function(a){return"string"==typeof a.data&&1!=a.data?a.data.substr("loginMark")?void location.reload():($.gritter.add({title:"Application",text:a.data}),!1):(a.data.jsMessage&&$.gritter.add({title:a.data.jsTitle,text:a.data.jsMessage}),a.data)},function(){$.gritter.add({title:"Application",text:"An error occured while processing your request."})});return h}};return b}]),function(){$(".txtedit").each(function(){var a=$(this).val();$(this).on("keyup",function(){$(this).val(a.replace(/,/g,""))})})}(),app.controller("MainController",["$scope",function(a){a.$on("LOAD",function(){a.loading=!0}),a.$on("UNLOAD",function(){a.loading=!1}),a.activeMenu="",a.setActiveMenu=function(b){a.activeMenu=b,console.log(b)},a.sortKey="id",a.sort=function(b){a.sortKey=b,a.reverse=!a.reverse},a.sortReportKey="",a.sortReport=function(b){a.sortReportKey=b,a.reverseReport=!a.reverseReport}}]),app.controller("OverviewController",["dataFactory","$scope","$http",function(a,b,c){function d(){g(),e(),h()}function e(){var c=b.filter;c.site="All Sites",c.partner="All Partners",c.placement="Overall",a.httpRequest("app/../reporting/reportFilters/"+b.pubId).then(function(a){b.filters=a})}function f(c,d,e,f){a.httpRequest("app/../reporting/generateReport/"+c+"/"+d+"/"+e+"/"+f).then(function(a){b.data=a,b.reports=a.reports,console.log(a),i(a)})}function g(){var a=["Today","Yesterday","This Week","Last Week","Last 7 Days","Last 14 Days","Last 30 Days","Last 60 Days","Last Month","This Month","Custom"];b.filter.ranges=a,b.filter.range="Last 30 Days"}function h(){a.httpRequest("app/../reporting/display/"+b.pubId+"/"+b.filter.range).then(function(a){b.data=a,b.reports=a.reports,i(a)})}function i(a){b.property=[];var c=b.property,d=a.reports,e=[],f={date:[],ecpm:[],impressions:[],revenue:[]},g={date:[],ecpm:[],impressions:[],revenue:[]},h=[],i=[];for(var k in d)c.push(k);if(c.length){for(var l=0;l<c.length;l++)e[c[l]]={site:c[l],partners:d[c[l]]};console.log(e)}for(var m in e){var n=e[m].partners,o=[],p=[],q=[],r=[];for(var s in n){for(var t=n[s],u=0;u<t.date.length;u++){var v=parseFloat(t.impressions[u]),w=j(parseFloat(t.revenue[u]));o[u]=t.date[u],p[u]=(parseFloat(p[u])?parseFloat(p[u]):0)+parseFloat(v),r[u]=j((parseFloat(r[u])?j(parseFloat(r[u])):0)+j(w));var x=parseFloat(r[u])/(parseFloat(p[u])/1e3);q[u]=isNaN(parseFloat(x))?0:j(parseFloat(x))}g.date.push(o),g.ecpm.push(q),g.impressions.push(p),g.revenue.push(r)}f.date.push(o),f.ecpm.push(q),f.impressions.push(p),f.revenue.push(r)}var y=[],z=0;for(var A in e)y.push({site:A,date:f.date[z],data:{ecpm:f.ecpm[z],impressions:f.impressions[z],revenue:f.revenue[z],overall:{revenue:parseFloat(f.revenue[z].reduce(function(a,b){return a+b},0).toFixed(2)),impressions:f.impressions[z].reduce(function(a,b){return a+b},0)}}}),z+=1;b.overall={revenue:0,impressions:0,ecpm:0};for(var B in y){switch(b.metric){case"Revenue":h.push({name:y[B].site,type:"spline",yAxis:1,data:y[B].data.revenue,tooltip:{valuePrefix:"$ "}});break;case"eCPM":h.push({name:y[B].site,type:"spline",yAxis:1,data:y[B].data.ecpm,tooltip:{valuePrefix:"$ "}});break;case"Impressions":h.push({name:y[B].site,type:"spline",yAxis:1,data:y[B].data.impressions,tooltip:{valuePrefix:""}})}var C=y[B].data.overall.revenue,D=parseFloat(y[B].data.overall.impressions);b.overall.revenue=parseFloat(b.overall.revenue)?parseFloat(b.overall.revenue)+C:C,b.overall.impressions=parseFloat(b.overall.impressions)?parseFloat(b.overall.impressions+D):D;var E=parseFloat(j(isNaN(b.overall.revenue/(b.overall.impressions/1e3))?0:b.overall.revenue/(b.overall.impressions/1e3)));b.overall.ecpm=E}switch(console.log(b.overall),b.metric){case"Revenue":i.push({labels:{format:"$ {value}",style:{color:Highcharts.getOptions().colors[2]}},title:{text:"Revenue",style:{color:Highcharts.getOptions().colors[2]}},opposite:!0});break;case"eCPM":i.push({gridLineWidth:0,labels:{format:"$ {value}",style:{color:Highcharts.getOptions().colors[0]}},title:{text:"eCPM",style:{color:Highcharts.getOptions().colors[0]}}});break;case"Impressions":i.push({gridLineWidth:0,title:{text:"Impressions",style:{color:Highcharts.getOptions().colors[1]}},labels:{format:"{value}",style:{color:Highcharts.getOptions().colors[1]}},opposite:!0})}var F=b.filter.range,m=b.filter.site,G=b.metric;Highcharts.chart("main-chart",{chart:{zoomType:"xy"},title:{text:m},subtitle:{text:F},xAxis:[{categories:y[0].date,crosshair:!0}],yAxis:[{labels:{format:"{value}",style:{color:Highcharts.getOptions().colors[2]}},title:{text:"",style:{color:Highcharts.getOptions().colors[2]}},opposite:!0},{gridLineWidth:0,title:{text:G,style:{color:Highcharts.getOptions().colors[6]}},labels:{format:"{value}",style:{color:Highcharts.getOptions().colors[6]}}}],tooltip:{shared:!0},legend:{layout:"horizontal",align:"center",x:0,verticalAlign:"top",y:55,floating:!1,backgroundColor:Highcharts.theme&&Highcharts.theme.legendBackgroundColor||"#FFFFFF"},series:h,credits:{enabled:!1}})}function j(a){return+(Math.round(a+"e+2")+"e-2")}b.data=[],b.reports=[],b.metric="Revenue",b.metrics=["eCPM","Impressions","Revenue"],b.overall={ecpm:0,impressions:0,revenue:0},b.filter={site:"",siteId:0,partner:"",placement:"",placementId:0,placementBySite:[],placementByPartner:[],placementFiltered:[],filteredSite:!1,filteredPartner:!1},b.setActiveMenu("overview"),d(),b.filterBySite=function(a,c){var d=b.filter,e=b.filters.placements;if(void 0!=a&&void 0!=c){if(d.site=b.filters.sites[a].siteName,b.filter.placementBySite=[],d.partnerId){d.placementBySite=[],d.placementFiltered=[];for(placement in e)e[placement].siteId==c&&e[placement].partnerId==d.partnerId&&(d.placementBySite.push(e[placement]),d.placementFiltered.push(e[placement]))}else{d.placementFiltered=[];for(placement in e)e[placement].siteId==c&&(d.placementBySite.push(e[placement]),d.placementFiltered.push(e[placement]))}d.siteId=c,d.placement="Overall",d.filteredSite=!0,f(b.pubId,d.siteId,d.placementId,b.filter.range)}else d.site="All Sites",b.filter.placementBySite=[],d.siteId="",d.filteredSite=!1,h();console.log(d)},b.filterByPartner=function(a,c){var d=b.filter,e=b.filters.placements;if(void 0!=a&&void 0!=c){if(d.partner=b.filters.partners[a].name,b.filter.placementByPartner=[],d.siteId){d.placementByPartner=[],d.placementFiltered=[];for(placement in e)e[placement].partnerId==c&&e[placement].siteId==d.siteId&&(d.placementByPartner.push(e[placement]),d.placementFiltered.push(e[placement]))}else{d.placementFiltered=[];for(placement in e)e[placement].partnerId==c&&(d.placementByPartner.push(e[placement]),d.placementFiltered.push(e[placement]))}d.partnerId=c,d.placement="Overall",d.filteredPartner=!0}else d.partner="All Partners",b.filter.placementByPartner=[],d.partnerId="",d.filteredPartner=!1},b.filterByPlacement=function(a){var c=b.filter;b.filters.placements;void 0!=a?(c.placement=a.placementName,b.filter.placementId=a.placementId):(c.placement="All Placements",c.placementId="")},b.filterByRange=function(a,c,d){b.filter.range=a,console.log(b.filter.siteId),b.filter.siteId?f(b.pubId,b.filter.siteId,"na",b.filter.range):h()},b.filterByMetric=function(a){b.metric=a,i(b.data)}}]),app.controller("PartnerController",["dataFactory","$scope","$http",function(a,b,c){function d(c){b.$emit("LOAD"),a.httpRequest("partners/?page="+c).then(function(a){b.partners=a.data,b.totalItems=a.total,b.pageNumber=c,b.$emit("UNLOAD")})}b.partners=[],b.pageNumber=1,b.libraryTemp={},b.totalItemsTemp={},b.totalItems=0,b.setActiveMenu("partners"),d(1),b.pageChanged=function(a){d(a)},b.searchDB=function(){b.searchText.length>=3?($.isEmptyObject(b.libraryTemp)&&(b.libraryTemp=b.partners,b.totalItemsTemp=b.totalItems,b.partners={}),d(1)):$.isEmptyObject(b.libraryTemp)||(b.partners=b.libraryTemp,b.totalItems=b.totalItemsTemp,b.libraryTemp={})},b.addPartner=function(){var c=b.form;a.httpRequest("partnersCreate/?name="+c.name+"&alias="+c.alias+"&url="+c.partnerSite).then(function(a){b.partners.push(a),d(1),$(".modal").modal("hide")})},b.editPartner=function(c){console.log(c),a.httpRequest("partnersEdit/"+c).then(function(a){b.form=a})},b.updatePartner=function(){a.httpRequest("partnersUpdate/"+b.form.id,"PUT",{},b.form).then(function(a){$(".modal").modal("hide"),b.partners=apiModifyTable(b.partners,a.id,a)})},b.removePartner=function(c,e){var f=confirm("Are you sure delete this item?","Delete");f&&a.httpRequest("partnersDelete/"+c.id,"DELETE").then(function(a){b.partners.splice(e,1),d(1)})},b.reset=function(){b.form=[]}}]),app.controller("PlacementsController",["dataFactory","$scope","$http","NgTableParams",function(a,b,c,d){function e(c,d){b.filter.placementName="",b.reportViewed=!1,b.$emit("LOAD"),a.httpRequest("app/../pubplacements/?page="+c+"&pubId="+d).then(function(a){b.pubPlacements=a.pubPlacements,b.totalPlacements=a.total,b.$emit("UNLOAD"),console.log(a.pubPlacements)})}function f(){b.pageNum=1,b.pageReport=1,b.filter={indexSite:0,indexPartner:0,site:"All Sites",partner:"All Partners",partnerAlias:"",placementName:""},b.siteId=0,b.partnerId=0,b.filteredBySite=0,b.filteredByPartner=0,b.cell=[],b.rows={data:[],selected:{},partner:"",index:0},b.reportViewed=!1,b.activeMenu="placements",e(1,b.pubId),g()}function g(){a.httpRequest("app/../initPlacementsData/"+b.pubId).then(function(a){b.pubSites=a.pubSites,b.pubPartners=a.pubPartners,console.log(b.pubPartners)})}b.setActiveMenu("placements"),b.totalPlacements=[],f(),b.pageChanged=function(a){b.filteredBySite&&!b.filteredByPartner?(b.pageNum=a,b.filterBySite(b.filter.indexSite,b.siteId)):b.filteredBySite&&b.filteredByPartner?(b.pageNum=a,b.filterByPartner(b.filter.indexPartner,b.partnerId)):(e(a,b.pubId),b.pageNum=a)},b.filterBySite=function(c,d){void 0!=c&&void 0!=d?(b.siteId=d,b.filter.site=b.pubSites[c].siteName,b.filter.indexSite=c,b.filter.placementName="",b.filteredBySite=1,b.totalReports=0,b.dataReports={},b.reportViewed=!1,b.$emit("LOAD"),a.httpRequest("app/../publishers/pubPlacementsBySite/?page="+b.pageNum+"&siteId="+b.siteId+"&partnerId="+b.partnerId+"&pubId="+b.pubId).then(function(a){b.pubPlacements=a.pubPlacements,b.totalPlacements=a.total,b.$emit("UNLOAD"),console.log(a)})):f()},b.filterByPartner=function(c,d){void 0!=c&&void 0!=d?(b.partnerId=d,b.filter.partnerAlias=b.pubPartners[c].alias,b.filter.partner=b.pubPartners[c].name,b.filter.indexPartner=c,b.filter.placementName="",b.filteredByPartner=1,b.totalReports=0,b.dataReports={},b.reportViewed=!1,b.$emit("LOAD"),a.httpRequest("app/../publishers/pubPlacementsByPartner/?page="+b.pageNum+"&siteId="+b.siteId+"&partnerId="+b.partnerId+"&pubId="+b.pubId).then(function(a){b.pubPlacements=a.pubPlacements,b.totalPlacements=a.total,b.$emit("LOAD"),console.log(a)})):(b.pageNum=1,b.filter.partner="All Partners",b.filter.partnerAlias="",b.partnerId=0,b.filteredBySite=1,b.filteredByPartner=0,b.filterBySite(b.filter.indexSite,b.siteId))},b.pageReportChange=function(a){b.pageReport=a;var c={alias:b.partner,id:b.placementid};b.viewReportsByPlacement(c)},b.viewReportsByPlacement=function(c){b.reportViewed=!0,b.partner=c.alias,b.placementid=c.id,b.$emit("LOAD"),a.httpRequest("app/../publishers/viewReportsByPlacement/?page="+b.pageReport+"&partner="+c.alias+"&placementId="+c.id).then(function(a){b.totalReports=a.reports.total,b.dataReports=a.reports.data,b.$emit("UNLOAD")}),b.filter.placementName=c.placementName}}]),app.controller("PublishersController",["dataFactory","$scope","$http",function(a,b,c){function d(c){b.$emit("LOAD"),a.httpRequest("publishers/?page="+c).then(function(a){b.publishers=a.publishers,b.totalPublishers=a.total,b.$emit("UNLOAD")})}b.publishers=[],b.pageNum=1,b.totalPublishers=0,b.setActiveMenu("publishers"),b.pageChanged=function(a){d(a)},d(1)}]),app.controller("PubPartnersController",["dataFactory","$scope","$http",function(a,b,c){function d(c,d){b.$emit("LOAD"),a.httpRequest("/app/pub/pubpartners/?page="+c+"&pubId="+d).then(function(a){b.pubPartners=a.pubPartners,b.totalPartners=a.total,b.$emit("UNLOAD"),console.log(a)})}b.publishers=[],b.pageNum=1,$totalPublishers=0,b.setActiveMenu("partners"),b.pageChanged=function(a){d(a,b.pubId),b.pageNum=a},d(1,b.pubId),b.updateStatus=function(c){b.$emit("LOAD"),a.httpRequest("/app/pub/updatePartnerStatus/?page="+b.pageNum+"&pubId="+c.pubId+"&partnerId="+c.partnerId+"&status="+c.status).then(function(a){b.pubPartners=a.pubPartners,b.$emit("UNLOAD")})}}]),app.controller("PubPlacementsController",["dataFactory","$scope","$http","NgTableParams",function(a,b,c,d){function e(){b.pageNum=1,b.pageReport=1,b.filter={site:"All Sites",indexSite:0,indexPartner:0,partner:"All Partners",partnerAlias:"",placementName:"",ranges:f(),range:"Last 30 Days",start:null,end:null,limit:7,rowsPerPage:[7,15,30,60,90,"All"]},f(),b.siteId=0,b.partnerId=0,b.filteredBySite=0,b.filteredByPartner=0,b.selectedPlacement={},b.cell=[],b.rows={data:[],selected:{},partner:"",index:0},b.search={placements:[],placement:""},b.placementFilter={siteName:"",name:"",placementName:""},b.reportViewed=!1,b.editMode=0,b.add=0,b.setActiveMenu("placements"),h(),g()}function f(){var a=["Today","Yesterday","This Week","Last Week","Last 7 Days","Last 14 Days","Last 30 Days","Last 60 Days","Last Month","This Month"];return a}function g(){a.httpRequest("/app/pub/initPlacementsData/"+b.pubId).then(function(a){b.pubSites=a.pubSites,b.pubPartners=a.pubPartners})}function h(){a.httpRequest("/app/pub/allplacements","POST",{pubId:b.pubId}).then(function(a){b.search.placements=a})}b.totalPlacements=[],e(),b.pageChanged=function(a){b.filteredBySite&&!b.filteredByPartner?(b.pageNum=a,b.filterBySite(b.filter.indexSite,b.siteId)):b.filteredBySite&&b.filteredByPartner?(b.pageNum=a,b.filterByPartner(b.filter.indexPartner,b.partnerId)):(getPlacements(a,b.pubId),b.pageNum=a)},b.addPlacement=function(){var c=b.placement,d={pubId:b.pubId,name:c.placementName,siteId:c.siteId,partnerId:c.partnerId};a.httpRequest("/app/pub/addNewPlacement","POST",d).then(function(a){b.pubPlacements=a.pubPlacements,b.totalPlacements=a.total,getPlacements(b.pageNum,b.pubId),b.placement=[],$(".modal").modal("hide")})},b.filterSite=function(a){b.placementFilter.siteName=a,""!=a&&(b.filteredBySite=1),b.totalReports=0,b.dataReports=[],b.reportViewed=!1},b.filterBySite=function(c,d){if(void 0!=c&&void 0!=d){b.siteId=d,b.filter.site=b.pubSites[c].siteName,b.filter.indexSite=c,b.filter.placementName="",b.filteredBySite=1,b.totalReports=0,b.dataReports={},b.reportViewed=!1,b.$emit("LOAD");var f={page:b.pageNum,pubId:b.pubId,siteId:b.siteId,partnerId:b.partnerId};a.httpRequest("/app/pub/pubPlacementsBySite","POST",f).then(function(a){b.pubPlacements=a.pubPlacements,b.totalPlacements=a.total,b.$emit("UNLOAD"),console.log(a)})}else e()},b.filterPartner=function(a){b.placementFilter.name=a,""!=a&&(b.filteredByPartner=1),b.totalReports=0,b.dataReports=[],b.reportViewed=!1},b.filterByPartner=function(c,d){if(void 0!=c&&void 0!=d){b.partnerId=d,b.filter.partnerAlias=b.pubPartners[c].alias,b.filter.partner=b.pubPartners[c].name,b.filter.indexPartner=c,b.filter.placementName="",b.filteredByPartner=1,b.totalReports=0,b.dataReports={},b.reportViewed=!1,b.$emit("LOAD");var e={page:b.pageNum,pubId:b.pubId,siteId:b.siteId,partnerId:b.partnerId};a.httpRequest("/app/pub/pubPlacementsByPartner","POST",e).then(function(a){b.pubPlacements=a.pubPlacements,b.totalPlacements=a.total,b.$emit("UNLOAD"),console.log(a)})}else b.pageNum=1,b.filter.partner="All Partners",b.filter.partnerAlias="",b.partnerId=0,b.filteredBySite=1,b.filteredByPartner=0,b.filterBySite(b.filter.indexSite,b.siteId)},b.resetPlacementFilter=function(){b.placementFilter.placementName=""},b.pageReportChange=function(a){b.pageReport=a;var c={alias:b.partner,id:b.placementid};b.viewReportsByPlacement(c)},b.viewReportsByPlacement=function(c){b.reportViewed=!0,b.partner=c.alias,b.placementid=c.id,b.selectedPlacement=c,b.$emit("LOAD");var d={data:{page:b.pageReport,partner:c.alias,placementId:c.id,range:b.filter.range,start:b.filter.start,end:b.filter.end,limit:b.filter.limit}};a.httpRequest("/app/pub/viewReportsByPlacement","POST",d).then(function(a){b.totalReports=a.reports.total,b.dataReports=a.reports.data,b.$emit("UNLOAD")}),b.filter.placementName=c.placementName},b.filterByRange=function(a){b.filter.range=a,"Custom"==a&&null==b.filter.start&&null==b.filter.end||b.viewReportsByPlacement(b.selectedPlacement)},b.filterByRangeCustom=function(a){b.filter.range=a,b.viewReportsByPlacement(b.selectedPlacement)},b.filterByRangeLimit=function(a){b.filter.limit=a,b.viewReportsByPlacement(b.selectedPlacement)},b.editRow=function(a,c){b.rows.data=angular.copy(a),b.rows.selected=angular.copy(a),b.rows.partner=b.partner,b.rows.index=c,b.editMode=1},b.saveRow=function(){b.dataReports[b.rows.index]=b.rows.data,a.httpRequest("/app/pub/updateReportByPlacement","GET",b.rows).then(function(a){b.dataReports[b.rows.index]=a}),b.editMode=0,b.rows.selected={}},b.editAll=function(){b.rows.data=angular.copy(b.dataReports),b.rows.selected=angular.copy(b.dataReports),b.rows.partner=b.partner,b.editMode=2,console.log(b.rows)},b.saveAll=function(){var c={data:{data:b.rows.data},partner:b.partner};b.dataReports=b.rows.data,a.httpRequest("/app/pub/updateReportByPlacement","POST",c).then(function(a){b.dataReports=a}),b.editMode=0,b.rows.selected={},console.log(b.rows)},b.cancelEdit=function(){b.add=0,b.editMode=0,b.rows.data=[],b.rows.selected={}},b.addNewReport=function(){b.add=1,console.log(b.add)},b.saveNewReport=function(c){b.rows.new.pubId=b.pubId,b.rows.new.placementid=b.placementid,console.log(c);var d={data:b.rows.new,partner:b.partner};a.httpRequest("/app/reporting/addNewReport","POST",d);var e={alias:b.partner,id:b.placementid};b.viewReportsByPlacement(e),b.add=0,b.rows.new={}},b.cancelReport=function(){b.add=0}}]),app.filter("placementFilter",[function(a){return function(a,b,c){if(!angular.isDefined(b)||""==b)return a;var d=[];return angular.forEach(a,function(a){a.txnType==c&&a.payee.name.toLowerCase().indexOf(b.toLowerCase())!=-1&&d.push(a)}),d}}]),app.controller("PubReportsController",["dataFactory","$scope","$http",function(a,b,c){function d(){g(),e(),h(null,null)}function e(){var c=b.filter;c.site="All Sites",c.partner="All Partners",c.placement="Overall",b.$emit("LOAD"),a.httpRequest("/app/reporting/reportFilters/"+b.pubId).then(function(a){b.filters=a,b.$emit("UNLOAD")})}function f(c,d,e,f,g,h){b.$emit("LOAD");var i={data:{pubId:c,siteId:d,placementId:e,range:f,start:g,end:h}};b.filteredBySite=!0,a.httpRequest("/app/reporting/generateReport","POST",i).then(function(a){b.data=a,b.reportsBySite=a.reports,j(),b.$emit("UNLOAD")})}function g(){var a=["Today","Yesterday","This Week","Last Week","Last 7 Days","Last 14 Days","Last 30 Days","Last 60 Days","Last Month","This Month","Custom"];b.filter.ranges=a,b.filter.range="Last 30 Days"}function h(c,d){b.$emit("LOAD");var e={data:{pubId:b.pubId,range:b.filter.range,start:c,end:d}};a.httpRequest("/app/reporting/display","POST",e).then(function(a){b.data=a,b.reports=a.reports,i(a),b.$emit("UNLOAD")})}function i(a){b.$emit("LOAD"),b.property=[];var c=b.property,d=a.reports,e=[],f={name:[],date:[],ecpm:[],impressions:[],revenue:[]},g={name:[],date:[],ecpm:[],impressions:[],revenue:[]},h=[],i=[];for(var j in d)c.push(j);if(c.length)for(var l=0;l<c.length;l++)e[c[l]]={site:c[l],partners:d[c[l]]};for(var m in e){var n=e[m].partners,o=[],p=[],q=[],r=[];for(var s in n){for(var t=n[s],u=0;u<t.date.length;u++){var v=parseFloat(t.impressions[u]),w=k(parseFloat(t.revenue[u]));o[u]=t.date[u],p[u]=(parseFloat(p[u])?parseFloat(p[u]):0)+parseFloat(v),r[u]=k((parseFloat(r[u])?k(parseFloat(r[u])):0)+k(w));var x=parseFloat(r[u])/(parseFloat(p[u])/1e3);q[u]=isNaN(parseFloat(x))?0:k(parseFloat(x))}g.name.push(t.title),g.date.push(o),g.ecpm.push(q),g.impressions.push(p),g.revenue.push(r)}f.name.push(e[m].site),f.date.push(o),f.ecpm.push(q),f.impressions.push(p),f.revenue.push(r)}var y=[],z=0;for(var A in e)y.push({site:A,date:f.date[z],data:{ecpm:f.ecpm[z],impressions:f.impressions[z],revenue:f.revenue[z],overall:{revenue:parseFloat(f.revenue[z].reduce(function(a,b){return a+b},0).toFixed(2)),impressions:f.impressions[z].reduce(function(a,b){return a+b},0)}}}),z+=1;b.overall={revenue:0,impressions:0,ecpm:0};for(var B in y){switch(b.metric){case"Revenue":h.push({name:y[B].site,type:"areaspline",yAxis:1,data:y[B].data.revenue,tooltip:{valuePrefix:"$ "}});break;case"eCPM":h.push({name:y[B].site,type:"areaspline",yAxis:1,data:y[B].data.ecpm,tooltip:{valuePrefix:"$ "}});break;case"Impressions":h.push({name:y[B].site,type:"areaspline",yAxis:1,data:y[B].data.impressions,tooltip:{valuePrefix:""}})}var C=y[B].data.overall.revenue,D=parseFloat(y[B].data.overall.impressions);b.overall.revenue=parseFloat(b.overall.revenue)?parseFloat(b.overall.revenue)+C:C,b.overall.impressions=parseFloat(b.overall.impressions)?parseFloat(b.overall.impressions+D):D;var E=parseFloat(k(isNaN(b.overall.revenue/(b.overall.impressions/1e3))?0:b.overall.revenue/(b.overall.impressions/1e3)));b.overall.ecpm=E}switch(b.metric){case"Revenue":i.push({labels:{format:"$ {value}",style:{color:Highcharts.getOptions().colors[2]}},title:{text:"Revenue",style:{color:Highcharts.getOptions().colors[2]}},opposite:!0});break;case"eCPM":i.push({gridLineWidth:0,labels:{format:"$ {value}",style:{color:Highcharts.getOptions().colors[0]}},title:{text:"eCPM",style:{color:Highcharts.getOptions().colors[0]}}});break;case"Impressions":i.push({gridLineWidth:0,title:{text:"Impressions",style:{color:Highcharts.getOptions().colors[1]}},labels:{format:"{value}",style:{color:Highcharts.getOptions().colors[1]}},opposite:!0})}var F="Custom"==b.filter.range?"Custom Range ( "+b.filter.start+" to "+b.filter.end+" )":b.filter.range,m=b.filter.site,G=b.metric;Highcharts.chart("main-chart",{chart:{zoomType:"xy"},title:{text:F},xAxis:[{categories:y[0].date,crosshair:!0}],yAxis:[{labels:{format:"{value}",style:{color:Highcharts.getOptions().colors[2]}},title:{text:"",style:{color:Highcharts.getOptions().colors[2]}},opposite:!0},{gridLineWidth:0,title:{text:G,style:{color:Highcharts.getOptions().colors[6]}},labels:{format:"{value}",style:{color:Highcharts.getOptions().colors[6]}}}],tooltip:{shared:!0},legend:{layout:"horizontal",align:"center",x:0,verticalAlign:"top",y:25,floating:!1,backgroundColor:Highcharts.theme&&Highcharts.theme.legendBackgroundColor||"#FAFAFA"},series:h,credits:{enabled:!1}}),b.$emit("UNLOAD")}function j(){var a=b.reportsBySite,c=[];for(var d in a){var e=a[d];for(var f in e){var g=e[f],h=[],i=[],j=[];for(var l in g.ecpm)i[l]=parseFloat(g.ecpm[l]);for(var m in g.impressions)h[m]=parseFloat(g.impressions[m]);for(var n in g.revenue)j[n]=k(parseFloat(g.revenue[n]));c.push({partner:g.title,date:g.date,data:{ecpm:i,revenue:j,impressions:h,overall:{revenue:parseFloat(j.reduce(function(a,b){return a+b},0).toFixed(2)),impressions:h.reduce(function(a,b){return a+b},0)}}})}var o=[];for(var g in c){switch(b.metric){case"Revenue":o.push({name:c[g].partner,type:"areaspline",yAxis:1,data:c[g].data.revenue,tooltip:{valuePrefix:"$ "}});break;case"eCPM":o.push({name:c[g].partner,type:"areaspline",yAxis:1,data:c[g].data.ecpm,tooltip:{valuePrefix:"$ "}});break;case"Impressions":o.push({name:c[g].partner,type:"spline",yAxis:1,data:c[g].data.impressions,tooltip:{valuePrefix:""}})}console.log(o)}}var p="Custom"==b.filter.range?"Custom Range ( "+b.filter.start+" to "+b.filter.end+" )":b.filter.range,d=b.filter.site,q=b.metric;Highcharts.chart("main-chart",{chart:{zoomType:"xy"},title:{text:p},xAxis:[{categories:c[0].date,crosshair:!0}],yAxis:[{labels:{format:"{value}",style:{color:Highcharts.getOptions().colors[2]}},title:{text:"",style:{color:Highcharts.getOptions().colors[2]}},opposite:!0},{gridLineWidth:0,title:{text:q,style:{color:Highcharts.getOptions().colors[6]}},labels:{format:"{value}",style:{color:Highcharts.getOptions().colors[6]}}}],tooltip:{shared:!0},legend:{layout:"horizontal",align:"center",x:0,verticalAlign:"top",y:25,floating:!1,backgroundColor:Highcharts.theme&&Highcharts.theme.legendBackgroundColor||"#FAFAFA"},series:o,credits:{enabled:!1}}),b.$emit("UNLOAD")}function k(a){return+(Math.round(a+"e+2")+"e-2")}b.data=[],b.reports=[],b.reportsBySite=[],b.reportsByPartner=[],b.metric="Revenue",b.metrics=["eCPM","Impressions","Revenue"],b.overall={ecpm:0,impressions:0,revenue:0},b.filter={site:"",siteId:0,partner:"",placement:"",placementId:0,placementBySite:[],placementByPartner:[],placementFiltered:[],filteredSite:!1,filteredPartner:!1,start:null,end:null},b.filteredBySite=!1,b.filteredByPartner=!1,b.setActiveMenu("reports"),d(),b.filterBySite=function(a,c){var d=b.filter,e=b.filters.placements;if("Custom"==b.filter.range&&null==b.filter.start&&null==b.filter.end&&(b.filter.range="Last 30 Days"),void 0!=a&&void 0!=c){if(d.site=b.filters.sites[a].siteName,b.filter.placementBySite=[],b.$emit("LOAD"),d.partnerId){d.placementBySite=[],d.placementFiltered=[];for(placement in e)e[placement].siteId==c&&e[placement].partnerId==d.partnerId&&(d.placementBySite.push(e[placement]),d.placementFiltered.push(e[placement]))}else{d.placementFiltered=[];for(placement in e)e[placement].siteId==c&&(d.placementBySite.push(e[placement]),d.placementFiltered.push(e[placement]))}d.siteId=c,d.placement="Overall",d.filteredSite=!0,null!=b.filter.start||null!=b.filter.end?f(b.pubId,d.siteId,d.placementId,b.filter.range,b.filter.start,b.filter.end):f(b.pubId,d.siteId,d.placementId,b.filter.range,null,null)}else{if(d.site="All Sites",b.filter.placementBySite=[],d.siteId="",d.filteredSite=!1,"Custom"==b.filter.range&&null==b.filter.start&&null==b.filter.end)return!1;null!=b.filter.start||null!=b.filter.end?h(b.filter.start,b.filter.end):h(null,null)}},b.filterByPartner=function(a,c){var d=b.filter,e=b.filters.placements;if(void 0!=a&&void 0!=c){if(d.partner=b.filters.partners[a].name,b.filter.placementByPartner=[],d.siteId){d.placementByPartner=[],d.placementFiltered=[];for(placement in e)e[placement].partnerId==c&&e[placement].siteId==d.siteId&&(d.placementByPartner.push(e[placement]),d.placementFiltered.push(e[placement]))}else{d.placementFiltered=[];for(placement in e)e[placement].partnerId==c&&(d.placementByPartner.push(e[placement]),d.placementFiltered.push(e[placement]))}d.partnerId=c,d.placement="Overall",d.filteredPartner=!0}else d.partner="All Partners",b.filter.placementByPartner=[],d.partnerId="",d.filteredPartner=!1},b.filterByPlacement=function(a){var c=b.filter;b.filters.placements;void 0!=a?(c.placement=a.placementName,b.filter.placementId=a.placementId):(c.placement="All Placements",c.placementId="")},b.filterByRange=function(a,c,d){return b.filter.range=a,b.filter.start=c,b.filter.end=d,("Custom"!=a||null!=c||null!=d)&&void(b.filter.siteId?"Custom"==a?f(b.pubId,b.filter.siteId,"na",b.filter.range,c,d):null!=b.filter.start||null!=b.filter.end?f(b.pubId,b.filter.siteId,"na",b.filter.range,b.filter.start,b.filter.end):f(b.pubId,b.filter.siteId,"na",b.filter.range,null,null):"Custom"==a?h(c,d):null!=b.filter.start||null!=b.filter.end?h(b.filter.start,b.filter.end):h(null,null))},b.applyCustomDate=function(a){b.filterByRange(b.filter.range,a.start,a.end)},b.filterByMetric=function(a){b.metric=a,1==b.filteredBySite?j():i(b.data)}}]),app.controller("PubSitesController",["dataFactory","$scope","$http",function(a,b,c){function d(c,d){b.$emit("LOAD"),a.httpRequest("/app/pub/pubsites/?page="+c+"&pubId="+d).then(function(a){b.pubSites=a.pubSites,b.pageNumber=c,b.totalSites=a.total,b.$emit("UNLOAD"),console.log(a)})}b.sites=[],b.publishers=[],b.pageNum=1,b.totalSites=0,b.setActiveMenu("sites"),b.pageChanged=function(a){d(a,b.pubId)},d(1,b.pubId),b.addNewSite=function(){b.sites.pubId=b.pubId;var c=b.sites;b.$emit("LOAD"),a.httpRequest("/app/pub/addNewSite/?pubId="+c.pubId+"&siteName="+c.siteName+"&siteUrl="+c.siteUrl).then(function(a){b.sites.push(a),b.$emit("UNLOAD"),$(".modal").modal("hide")})}}]),app.controller("ReportsController",["dataFactory","$scope","$http",function(a,b,c){function d(){g(),e(),h(null,null)}function e(){var c=b.filter;c.site="All Sites",c.partner="All Partners",c.placement="Overall",b.$emit("LOAD"),a.httpRequest("/app/reporting/reportFilters/"+b.pubId).then(function(a){b.filters=a,b.$emit("UNLOAD")})}function f(c,d,e,f,g,h){b.$emit("LOAD");var j={data:{pubId:c,siteId:d,placementId:e,range:f,start:g,end:h}};console.log(j),a.httpRequest("/app/reporting/generateReport","POST",j).then(function(a){b.data=a,b.reports=a.reports,i(a),b.$emit("UNLOAD")})}function g(){var a=["Today","Yesterday","This Week","Last Week","Last 7 Days","Last 14 Days","Last 30 Days","Last 60 Days","Last Month","This Month","Custom"];b.filter.ranges=a,b.filter.range="Last 30 Days"}function h(c,d){b.$emit("LOAD");var e={data:{pubId:b.pubId,range:b.filter.range,start:c,end:d}};a.httpRequest("/app/reporting/display","POST",e).then(function(a){b.data=a,b.reports=a.reports,i(a),b.$emit("UNLOAD")})}function i(a){b.$emit("LOAD"),b.property=[];var c=b.property,d=a.reports,e=[],f={date:[],ecpm:[],impressions:[],revenue:[]},g={date:[],ecpm:[],impressions:[],revenue:[]},h=[],i=[];for(var k in d)c.push(k);if(c.length)for(var l=0;l<c.length;l++)e[c[l]]={site:c[l],partners:d[c[l]]};for(var m in e){var n=e[m].partners,o=[],p=[],q=[],r=[];for(var s in n){for(var t=n[s],u=0;u<t.date.length;u++){var v=parseFloat(t.impressions[u]),w=j(parseFloat(t.revenue[u]));o[u]=t.date[u],p[u]=(parseFloat(p[u])?parseFloat(p[u]):0)+parseFloat(v),r[u]=j((parseFloat(r[u])?j(parseFloat(r[u])):0)+j(w));var x=parseFloat(r[u])/(parseFloat(p[u])/1e3);q[u]=isNaN(parseFloat(x))?0:j(parseFloat(x))}g.date.push(o),g.ecpm.push(q),g.impressions.push(p),g.revenue.push(r)}f.date.push(o),f.ecpm.push(q),f.impressions.push(p),f.revenue.push(r)}var y=[],z=0;for(var A in e)y.push({site:A,date:f.date[z],data:{ecpm:f.ecpm[z],impressions:f.impressions[z],revenue:f.revenue[z],overall:{revenue:parseFloat(f.revenue[z].reduce(function(a,b){return a+b},0).toFixed(2)),impressions:f.impressions[z].reduce(function(a,b){return a+b},0)}}}),z+=1;b.overall={revenue:0,impressions:0,ecpm:0};for(var B in y){switch(b.metric){case"Revenue":h.push({name:y[B].site,type:"areaspline",yAxis:1,data:y[B].data.revenue,tooltip:{valuePrefix:"$ "}});break;case"eCPM":h.push({name:y[B].site,type:"areaspline",yAxis:1,data:y[B].data.ecpm,tooltip:{valuePrefix:"$ "}});break;case"Impressions":h.push({name:y[B].site,type:"areaspline",yAxis:1,data:y[B].data.impressions,tooltip:{valuePrefix:""}})}var C=y[B].data.overall.revenue,D=parseFloat(y[B].data.overall.impressions);b.overall.revenue=parseFloat(b.overall.revenue)?parseFloat(b.overall.revenue)+C:C,
b.overall.impressions=parseFloat(b.overall.impressions)?parseFloat(b.overall.impressions+D):D;var E=parseFloat(j(isNaN(b.overall.revenue/(b.overall.impressions/1e3))?0:b.overall.revenue/(b.overall.impressions/1e3)));b.overall.ecpm=E}switch(b.metric){case"Revenue":i.push({labels:{format:"$ {value}",style:{color:Highcharts.getOptions().colors[2]}},title:{text:"Revenue",style:{color:Highcharts.getOptions().colors[2]}},opposite:!0});break;case"eCPM":i.push({gridLineWidth:0,labels:{format:"$ {value}",style:{color:Highcharts.getOptions().colors[0]}},title:{text:"eCPM",style:{color:Highcharts.getOptions().colors[0]}}});break;case"Impressions":i.push({gridLineWidth:0,title:{text:"Impressions",style:{color:Highcharts.getOptions().colors[1]}},labels:{format:"{value}",style:{color:Highcharts.getOptions().colors[1]}},opposite:!0})}var F="Custom"==b.filter.range?"Custom Range ( "+b.filter.start+" to "+b.filter.end+" )":b.filter.range,m=b.filter.site,G=b.metric;Highcharts.chart("main-chart",{chart:{zoomType:"xy"},title:{text:F},xAxis:[{categories:y[0].date,crosshair:!0}],yAxis:[{labels:{format:"{value}",style:{color:Highcharts.getOptions().colors[2]}},title:{text:"",style:{color:Highcharts.getOptions().colors[2]}},opposite:!0},{gridLineWidth:0,title:{text:G,style:{color:Highcharts.getOptions().colors[6]}},labels:{format:"{value}",style:{color:Highcharts.getOptions().colors[6]}}}],tooltip:{shared:!0},legend:{layout:"horizontal",align:"center",x:0,verticalAlign:"top",y:25,floating:!1,backgroundColor:Highcharts.theme&&Highcharts.theme.legendBackgroundColor||"#FAFAFA"},series:h,credits:{enabled:!1}}),b.$emit("UNLOAD")}function j(a){return+(Math.round(a+"e+2")+"e-2")}b.data=[],b.reports=[],b.metric="Revenue",b.metrics=["eCPM","Impressions","Revenue"],b.overall={ecpm:0,impressions:0,revenue:0},b.filter={site:"",siteId:0,partner:"",placement:"",placementId:0,placementBySite:[],placementByPartner:[],placementFiltered:[],filteredSite:!1,filteredPartner:!1,start:null,end:null},b.setActiveMenu("reports"),d(),b.filterBySite=function(a,c){var d=b.filter,e=b.filters.placements;if("Custom"==b.filter.range&&null==b.filter.start&&null==b.filter.end&&(b.filter.range="Last 30 Days"),void 0!=a&&void 0!=c){if(d.site=b.filters.sites[a].siteName,b.filter.placementBySite=[],b.$emit("LOAD"),d.partnerId){d.placementBySite=[],d.placementFiltered=[];for(placement in e)e[placement].siteId==c&&e[placement].partnerId==d.partnerId&&(d.placementBySite.push(e[placement]),d.placementFiltered.push(e[placement]))}else{d.placementFiltered=[];for(placement in e)e[placement].siteId==c&&(d.placementBySite.push(e[placement]),d.placementFiltered.push(e[placement]))}d.siteId=c,d.placement="Overall",d.filteredSite=!0,null!=b.filter.start||null!=b.filter.end?f(b.pubId,d.siteId,d.placementId,b.filter.range,b.filter.start,b.filter.end):f(b.pubId,d.siteId,d.placementId,b.filter.range,null,null)}else{if(d.site="All Sites",b.filter.placementBySite=[],d.siteId="",d.filteredSite=!1,"Custom"==b.filter.range&&null==b.filter.start&&null==b.filter.end)return!1;null!=b.filter.start||null!=b.filter.end?h(b.filter.start,b.filter.end):h(null,null)}},b.filterByPartner=function(a,c){var d=b.filter,e=b.filters.placements;if(void 0!=a&&void 0!=c){if(d.partner=b.filters.partners[a].name,b.filter.placementByPartner=[],d.siteId){d.placementByPartner=[],d.placementFiltered=[];for(placement in e)e[placement].partnerId==c&&e[placement].siteId==d.siteId&&(d.placementByPartner.push(e[placement]),d.placementFiltered.push(e[placement]))}else{d.placementFiltered=[];for(placement in e)e[placement].partnerId==c&&(d.placementByPartner.push(e[placement]),d.placementFiltered.push(e[placement]))}d.partnerId=c,d.placement="Overall",d.filteredPartner=!0}else d.partner="All Partners",b.filter.placementByPartner=[],d.partnerId="",d.filteredPartner=!1},b.filterByPlacement=function(a){var c=b.filter;b.filters.placements;void 0!=a?(c.placement=a.placementName,b.filter.placementId=a.placementId):(c.placement="All Placements",c.placementId="")},b.filterByRange=function(a,c,d){return b.filter.range=a,b.filter.start=c,b.filter.end=d,("Custom"!=a||null!=c||null!=d)&&void(b.filter.siteId?"Custom"==a?f(b.pubId,b.filter.siteId,"na",b.filter.range,c,d):null!=b.filter.start||null!=b.filter.end?f(b.pubId,b.filter.siteId,"na",b.filter.range,b.filter.start,b.filter.end):f(b.pubId,b.filter.siteId,"na",b.filter.range,null,null):"Custom"==a?h(c,d):null!=b.filter.start||null!=b.filter.end?h(b.filter.start,b.filter.end):h(null,null))},b.applyCustomDate=function(a){b.filterByRange(b.filter.range,a.start,a.end)},b.filterByMetric=function(a){b.metric=a,i(b.data)}}]),app.controller("SidebarController",["$scope",function(a){a.activeMenu=function(a){return a}}]),app.controller("SitesController",["dataFactory","$scope","$http",function(a,b,c){function d(c,d){b.data={page:c,pubId:d},b.$emit("LOAD"),a.httpRequest("app/../sites","GET",b.data).then(function(a){b.pubSites=a.pubSites,b.pageNumber=c,b.totalSites=a.total,b.$emit("UNLOAD"),console.log(a)})}b.sites=[],b.publishers=[],b.pageNum=1,b.totalSites=0,b.setActiveMenu("sites"),b.pageChanged=function(a){d(a,b.pubId)},d(1,b.pubId),b.addNewSite=function(){b.sites.pubId=b.pubId;var c=b.sites;a.httpRequest("../../../addNewSite/?pubId="+c.pubId+"&siteName="+c.siteName+"&siteUrl="+c.siteUrl).then(function(a){b.sites.push(a),$(".modal").modal("hide")})}}]);